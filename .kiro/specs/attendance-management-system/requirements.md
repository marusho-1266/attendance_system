# 要件定義書

## 概要

本文書は、Google Apps ScriptとGoogle スプレッドシートを使用した小規模組織（50名以下）向けの出勤管理システムの要件を定義します。このシステムは、Googleの無料枠内で動作し、打刻機能、承認ワークフロー、自動計算、レポート機能を提供します。

## 要件

### 要件1

**ユーザーストーリー:** 従業員として、Webアプリケーションを使用して出退勤を打刻したい。これにより、出勤状況が自動的に記録・追跡される。

#### 受入基準

1. 従業員がWebアプリケーションにアクセスした時、システムは`Session.getActiveUser().getEmail()`を使用して認証を行う
2. 認証された従業員が打刻アクション（IN/OUT/BRK_IN/BRK_OUT）を選択した時、システムはLog_Rawシートにタイムスタンプを記録する
3. 従業員が同日に同じアクションを二重に打刻しようとした時、システムは重複エントリを防止しエラーメッセージを表示する
4. 従業員が出勤打刻なしに退勤打刻をしようとした時、システムは検証エラーを表示する
5. 打刻アクションが正常に記録された時、システムは確認メッセージを表示する

### 要件2

**ユーザーストーリー:** 従業員として、時刻修正、残業、休暇の申請を提出したい。これにより、出勤記録が適切に調整される。

#### 受入基準

1. 従業員がGoogleフォームを通じて申請を提出した時、システムはRequest_Responsesシートにステータス「Pending」で記録する
2. 申請が提出された時、システムはMaster_Employeeシートから適切な承認者を特定する
3. 同日に同じ承認者に対して複数の申請が提出された時、システはそれらを1通の通知メールにまとめる
4. 申請が提出された時、システムは必須フィールドがすべて完了していることを検証する
5. 申請の提出が失敗した場合、システムはエラーをログに記録し管理者に通知する

### 要件3

**ユーザーストーリー:** 承認者として、シンプルなドロップダウンインターフェースを使用して申請を承認または却下したい。これにより、出勤申請を効率的に処理できる。

#### 受入基準

1. 承認者が通知メールを受信した時、システムは承認シートへのリンクを提供する
2. 承認者がRequest_Responsesシートを開いた時、システムは担当する申請のステータス列のみ編集を許可する
3. 承認者がドロップダウンから「Approved」または「Rejected」を選択した時、システムは申請ステータスを自動更新する
4. 申請ステータスが変更された時、システムは次回の日次ジョブで出勤サマリーの再計算をトリガーする
5. 申請が処理された時、システムは申請者に通知メールを送信する

### 要件4

**ユーザーストーリー:** システム管理者として、日次、週次、月次の自動処理を実行したい。これにより、出勤データが一貫して計算され、レポートが生成される。

#### 受入基準

1. 日次ジョブがAsia/Tokyo 02:00に実行される時、システムは前日分のDaily_Summaryシートを更新する
2. 日次ジョブが退勤打刻漏れの従業員を検出した時、システムは該当する全従業員と管理者に1通のサマリーメールを送信する
3. 週次ジョブが月曜日Asia/Tokyo 07:00に実行される時、システムは過去4週間の残業時間を計算し、80時間を超える従業員に警告を送信する
4. 月次ジョブが1日Asia/Tokyo 02:30に実行される時、システムはMonthly_Summaryシートを更新し、CSVファイルをGoogle Driveにエクスポートする
5. 自動ジョブが失敗した場合、システムは即座にエラー詳細を管理者に通知する

### 要件5

**ユーザーストーリー:** 従業員として、残業、休憩控除、祝日考慮を含む労働時間を自動計算してほしい。これにより、出勤記録が正確になる。

#### 受入基準

1. 日次労働時間を計算する時、システムは実労働時間、残業時間、遅刻・早退を決定する
2. 従業員が6時間以上8時間未満働いた時、システムは休憩時間として45分を自動控除する
3. 従業員が8時間を超えて働いた時、システムは休憩時間として60分を自動控除する
4. 残業を計算する時、システムはMaster_Holidayシートの祝日を考慮する
5. 出勤データを処理する時、システムは法定休日と会社休日を区別する
6. 深夜勤務時間を計算する時、システムは深夜労働に適切な時間計算を適用する

### 要件6

**ユーザーストーリー:** システム管理者として、包括的なエラーハンドリングとログ記録を実装したい。これにより、システム障害が迅速に特定・解決される。

#### 受入基準

1. スクリプト関数でエラーが発生した時、システムはtry-catchブロックでラップする
2. エラーが発生した時、システムはエラー詳細をログに記録し、即座に管理者にメール送信する
3. クォータ制限に近づいた時、システムは制限内に収めるためのバッチ処理戦略を実装する
4. メールクォータが制約される時、システムは個別通知の代わりにサマリーメールを使用する
5. スクリプト実行時間制限に達した時、システムはデータをチャンクで処理し、処理を再開する

### 要件7

**ユーザーストーリー:** システム管理者として、適切なアクセス制御とデータ保護を実装したい。これにより、機密の出勤データが安全に保護される。

#### 受入基準

1. 従業員がシステムにアクセスする時、システムはMaster_Employeeシートにメールアドレスが存在することを確認する
2. 生ログデータを保護する時、システムはLog_Rawシートを管理者以外すべて読み取り専用にする
3. サマリーシートを共有する時、システムは全従業員に読み取り専用アクセスを提供する
4. 承認ワークフローを管理する時、システムは承認者が担当する申請のステータス列のみ編集を許可する
5. システム所有権が変更される時、システムはアクセス問題を防ぐため共有組織Gmailアカウントを使用する

### 要件8

**ユーザーストーリー:** 管理者として、自動レポートとアラートを受信したい。これにより、出勤パターンとコンプライアンス問題を監視できる。

#### 受入基準

1. 日次サマリーを生成する時、システムは各従業員の出勤、労働時間、残業を示すレポートを作成する
2. 月次サマリーを作成する時、システムは勤務日数、総労働時間、残業、休暇使用を集計する
3. データをエクスポートする時、システムはCSVファイルを生成しGoogle Driveにアクセスリンク付きで保存する
4. 残業閾値を超えた時、システムは管理者に週次アラートメールを送信する
5. レポートを生成する時、システムはすべての時間調整の承認ステータスを含める